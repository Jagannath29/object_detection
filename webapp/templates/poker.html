<!-- Poker Card Detector Page - Minimal Dark Theme -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Poker Card Detector</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', Arial, sans-serif; }
    .accent {
      color: #38bdf8;
    }
    .accent-btn {
      background: #38bdf8;
      color: #fff;
      font-weight: 700;
      border: none;
      transition: background 0.2s;
    }
    .accent-btn:hover {
      background: #0ea5e9;
    }
    .dark-card {
      background: #23272f;
    }
    .dark-link {
      color: #b6c2e2;
      transition: color 0.2s;
    }
    .dark-link:hover {
      color: #38bdf8;
    }
  </style>
</head>
<body class="min-h-screen bg-[#18181b]">
  <div class="max-w-2xl mx-auto py-10 px-4">
    <a href="/" class="dark-link text-base font-semibold">&larr; Back to Dashboard</a>
    <div class="dark-card rounded-2xl p-8 mt-6 flex flex-col items-center">
      <h1 class="text-3xl font-bold mb-2 mt-2 accent">Poker Card Detector</h1>
      <p class="text-gray-200 mb-6 text-center">Show your cards to the webcam to detect poker hands.</p>
      <button id="start-poker-webcam" class="accent-btn px-4 py-2 rounded font-semibold mb-2">Start Webcam Detection</button>
      <div id="poker-webcam-area" class="mt-4 hidden w-full">
        <div class="text-center text-gray-300 mb-2">Show your cards to the webcam below:</div>
        <img id="poker-webcam-stream" class="max-w-full rounded-xl mx-auto border-2 border-blue-400" src="/poker/stream" alt="Poker Webcam Stream" />
        <div class="mt-2 text-lg font-bold text-blue-300" id="poker-webcam-status">Show 5 cards to the camera to see your hand detected live.</div>
      </div>
      <form id="poker-form" enctype="multipart/form-data" class="hidden mb-2 w-full">
        <input type="file" name="file" accept="image/*,video/*" class="mb-2 block w-full bg-[#18181b] text-gray-200 border border-[#334155] rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
        <button type="submit" class="accent-btn px-4 py-2 rounded w-full font-semibold mt-1">Run Detection</button>
      </form>
      <div id="poker-status" class="mt-2 text-sm text-blue-300"></div>
      <div id="poker-output" class="mt-4"></div>
    </div>
  </div>
  <script>
    // Poker Card Detector form and webcam logic
    document.getElementById('poker-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = e.target;
      const data = new FormData(form);
      document.getElementById('poker-status').textContent = 'Processing...';
      document.getElementById('poker-output').innerHTML = `<div class=\"flex justify-center\"><svg class=\"animate-spin h-10 w-10 text-gray-400\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\"><circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle><path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8v8z\"></path></svg></div>`;
      fetch('/detect/poker', { method: 'POST', body: data })
        .then(res => res.json())
        .then(res => {
          document.getElementById('poker-status').textContent = res.status || '';
          if (res.output_url) {
            if (res.output_url.match(/\.(jpg|jpeg|png)$/i)) {
              document.getElementById('poker-output').innerHTML = `<div class='bg-white rounded-xl shadow-lg p-4'><img src="${res.output_url}" class="max-w-full rounded shadow"></div>`;
            } else if (res.output_url.match(/\.(mp4|avi)$/i)) {
              document.getElementById('poker-output').innerHTML = `<div class='bg-white rounded-xl shadow-lg p-4'><video src="${res.output_url}" controls class="max-w-full rounded shadow"></video></div>`;
            }
          }
          if (res.cards && res.cards.length) {
            document.getElementById('poker-output').innerHTML += `<div class=\"mt-2 text-lg font-bold\">Cards: ${res.cards.join(', ')}</div>`;
          }
        })
        .catch(err => {
          document.getElementById('poker-status').textContent = 'Error: ' + err;
          document.getElementById('poker-output').innerHTML = '';
        });
    });

    document.getElementById('start-poker-webcam').addEventListener('click', function() {
      document.getElementById('poker-webcam-area').classList.remove('hidden');
      document.getElementById('poker-form').classList.add('hidden');
      startPokerWebcamDetection();
    });

    function startPokerWebcamDetection() {
      const video = document.createElement('video');
      video.setAttribute('autoplay', '');
      video.setAttribute('playsinline', '');
      video.width = 640;
      video.height = 480;
      const imgTag = document.getElementById('poker-webcam-stream');
      let stream = null;
      let stopRequested = false;
      navigator.mediaDevices.getUserMedia({ video: true }).then(s => {
        stream = s;
        video.srcObject = stream;
        video.play();
        // Listen for 'q' key to stop webcam
        window.addEventListener('keydown', function onKey(e) {
          if (e.key === 'q' || e.key === 'Q') {
            stopRequested = true;
            if (stream) {
              stream.getTracks().forEach(track => track.stop());
            }
            imgTag.src = '';
            document.getElementById('poker-webcam-area').classList.add('hidden');
            window.removeEventListener('keydown', onKey);
          }
        });
        sendPokerFrame();
        function sendPokerFrame() {
          if (imgTag.closest('.hidden') || stopRequested) return; // Stop if hidden or requested
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          canvas.toBlob(blob => {
            const formData = new FormData();
            formData.append('frame', blob, 'frame.jpg');
            fetch('/detect/poker/webcam', {
              method: 'POST',
              body: formData
            })
              .then(res => {
                const handName = res.headers.get('X-Hand-Name');
                if (handName) {
                  document.getElementById('poker-webcam-status').textContent = 'Detected Hand: ' + handName;
                } else {
                  document.getElementById('poker-webcam-status').textContent = 'Show 5 cards to the camera to see your hand detected live.';
                }
                return res.blob();
              })
              .then(blob => {
                imgTag.src = URL.createObjectURL(blob);
                setTimeout(sendPokerFrame, 300); // ~3 FPS
              })
              .catch(() => setTimeout(sendPokerFrame, 1000));
          }, 'image/jpeg');
        }
      });
    }
  </script>
</body>
</html>
